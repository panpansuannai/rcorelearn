## æ‚é¡¹
- åœ¨å®ä¸­å¯ä»¥ä½¿ç”¨()[]{}, ä¾‹å¦‚vec![1,2,3],vec!(1,2,3),vec!{1,2,3}æ˜¯
  ç­‰ä»·çš„,åœ¨å£°æ˜å®çš„å®ä½“å†…åŒç†
``` rust
macro_rules! m {
  (how are you) => ( println!("fine"); );
  [how old are you] => { println!("18"); };
}
```

## macro\_rules
### æ¨¡å¼åŒ¹é…
macro\_rules å†…ä½¿ç”¨æ¨¡å¼åŒ¹é…,è¾“å…¥ä¸è§„åˆ™åŒ¹é…åå°†è§„åˆ™å³è¾¹çš„ç»“æ„åœ¨å®è°ƒç”¨å¤„å±•å¼€ä¸ºAST
```rust
macro_rules! four{
  () => { 1 + 3 };
}

let a = 1 + four!();
```

### å…ƒå˜é‡
- block å—ï¼šæ¯”å¦‚ç”¨å¤§æ‹¬å·åŒ…å›´èµ·æ¥çš„è¯­å¥å’Œ/æˆ–è¡¨è¾¾å¼
- expr è¡¨è¾¾å¼ (expression)
- ident æ ‡è¯†ç¬¦ (identifier)ï¼šåŒ…æ‹¬å…³é”®å­— (keywords)
- item æ¡ç›®ï¼šæ¯”å¦‚å‡½æ•°ã€ç»“æ„ä½“ã€æ¨¡å—ã€impl å—
- lifetime ç”Ÿå‘½å‘¨æœŸæ³¨è§£ï¼šæ¯”å¦‚ 'fooã€'static
- literal å­—é¢å€¼ï¼šæ¯”å¦‚ "Hello World!"ã€3.14ã€'ğŸ¦€'
- meta å…ƒä¿¡æ¯ï¼šæŒ‡ #[...] å’Œ #![...] å±æ€§å†…éƒ¨çš„å…ƒä¿¡æ¯æ¡ç›®
- pat æ¨¡å¼ (pattern)
- path è·¯å¾„ï¼šæ¯”å¦‚ fooã€::std::mem::replaceã€transmute::<_, int>
- stmt è¯­å¥ (statement)
- ttï¼šå•æ£µæ ‡è®°æ ‘ (single token tree)
- ty ç±»å‹
- vis å¯è§†æ ‡è¯†ç¬¦ï¼šå¯èƒ½ä¸ºç©ºçš„å¯è§†æ ‡è¯†ç¬¦ï¼Œæ¯”å¦‚ pubã€pub(in crate)

```rust
macro_rules! multi {
  ($a:expr, $b:expr) => { $a * $b };
}
```

### åå¤æ•è·
ä¸€èˆ¬æ¨¡å¼ä¸º$(...) sep rep,å…¶ä¸­sepä¸ºåˆ†éš”ç¬¦,å¯ä»¥çœç•¥,repä¸ºä»¥ä¸‹ä¸‰ç§æƒ…å†µ
- * 0æ¬¡åˆ°å¤šæ¬¡
- + 1æ¬¡åˆ°å¤šæ¬¡
- ? 0æ¬¡æˆ–1æ¬¡
åœ¨å®å±•å¼€çš„åœ°æ–¹åŒæ ·ä½¿ç”¨ä¸Šè¿°æ¨¡å¼
```rust
macro_rules! vec {
  ($($e:expr),*) => {
    let v = Vec::new();
    $(
      v.push($e);
    )*
    v
  };
}
```
å¦‚æœè§„åˆ™å†…åŒ…å«å¤šä¸ªé‡å¤,è°ƒç”¨æ—¶æ¯ä¸ªé‡å¤çš„æ¬¡æ•°éœ€ä¿æŒä¸€è‡´

### å›è°ƒ
å®å±•å¼€ä¸èƒ½å°†ä¸€ä¸ªå®å±•å¼€çš„å†…å®¹ä¼ é€’ç»™å¦ä¸€ä¸ªå®
```
macro1!(macro2()) // macro2ä¸ä¼šå±•å¼€
```
ä½¿ç”¨å›è°ƒå®å¯ä»¥å®ç°
```
macro_rules! callback {
    ($name:ident( $($args:tt),* ) ) => {
        $name!( $($args),* )
    };
}

macro_rules! m {
    ($($n:tt),*) => {println!("hello {} {}",$($n),*)};
}

fn main(){
    m1!(m2("first", "second"));
}
```
ç»“æœä¸º
```
hello first second
```

### å†…ç”¨è§„åˆ™
```
// ä½¿ç”¨as_exprä½œä¸ºåç§°å£°æ˜äº†ä¸€ä¸ªå†…éƒ¨å®,
// è¯¥å®å¯¹å¤–éƒ¨ä¸å¯è§
macro_rules! foo {
    (@as_expr $e:expr) => {$e};

    ($($tts:tt)*) => {
        foo!(@as_expr $($tts)*)
    };
}

fn main(){
  assert_eq!(foo!(40+2), 42);
}
```
